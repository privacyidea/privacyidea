<div
  aria-label="Realm Layout"
  class="realm-layout"
  i18n-aria-label>
  <div
    appScrollToTop
    class="realm-table-container">
    <div class="filter-paginator-container">
      <mat-form-field
        class="token-table-filter"
        subscriptSizing="dynamic">
        <mat-label i18n>Filter Realms...</mat-label>
        <app-clearable-input
          (onClick)="resetFilter()"
          [showClearButton]="filterString().length > 0">
          <input
            #filterHTMLInputElement
            (input)="onFilterInput(filterHTMLInputElement.value)"
            [value]="filterString()"
            aria-label="Filter Input"
            i18n-aria-label
            i18n-placeholder
            matInput
            placeholder="Filter across all columns." />
        </app-clearable-input>
      </mat-form-field>
      <mat-paginator
        [length]="totalLength()"
        [pageSizeOptions]="pageSizeOptions()"
        [pageSize]="pageSizeOptions()[0]"
        showFirstLastButtons></mat-paginator>
    </div>

    <div class="flex-row margin-bottom-1 margin-top-1">
      <mat-form-field
        subscriptSizing="dynamic">
        <mat-label i18n>Node</mat-label>

        <mat-select
          (selectionChange)="onNodeSelectionChange($event.value)"
          [value]="selectedNode()">

          @for (node of nodeOptions(); track node.value) {
            <mat-option [value]="node.value">
              {{ node.label }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    <div class="audit-table-overflow">
      <table
        [dataSource]="realmsDataSource()"
        aria-label="Realm Data Table"
        class="token-table"
        mat-table
        matSort>
        @for (column of columnKeysMap; track column) {
          <ng-container [matColumnDef]="column.key">
            <th
              *matHeaderCellDef
              attr.aria-label="{{ column.label }} Header"
              mat-header-cell
              mat-sort-header>
              {{ column.label }}
            </th>

            <td
              *matCellDef="let element"
              [ngClass]="{
                'width-100': column.key === 'resolvers',
                'actions-cell': column.key === 'actions',
              }"
              attr.aria-label="{{ column.label }} Cell"
              mat-cell>
              @switch (column.key) {
                @case ("name") {
                  <span>{{ element.name }}</span>
                }
                @case ("isDefault") {
                  <div class="flex just-center">
                    <button
                      (click)="onSetDefaultRealm(element)"
                      [attr.aria-label]="element.isDefault ? 'Default realm' : 'Set as default realm'"
                      [disabled]="element.isDefault"
                      mat-icon-button
                      type="button">
                      <mat-icon
                        [ngClass]="{
                          'icon-true': element.isDefault,
                        }">
                        {{ element.isDefault ? "radio_button_checked" : "radio_button_unchecked" }}
                      </mat-icon>
                    </button>
                  </div>
                }
                @case ("resolvers") {
                  @if (editingRealmName() === element.name) {
                    <div class="node-resolvers-groups">
                      @for (group of allNodeGroups(); track group.id) {
                        <div class="node-resolvers-group">
                          <div class="resolver-node-label">
                            <mat-icon
                              aria-hidden="true"
                              class="resolver-node-icon">
                              dns
                            </mat-icon>
                            <span>{{ group.label }}</span>
                          </div>

                          <mat-form-field
                            class="node-resolvers-select"
                            subscriptSizing="dynamic">
                            <mat-label i18n>Resolvers</mat-label>
                            <mat-select
                              (selectionChange)="onEditNodeResolversChange(group.id, $event.value)"
                              [value]="getEditNodeResolverNames(group.id)"
                              multiple>
                              @for (res of resolverOptions(); track res.name) {
                                <mat-option [value]="res.name">
                                  {{ res.name }} ({{ res.type }})
                                </mat-option>
                              }
                            </mat-select>
                            <div class="resolver-priority-list">
                              @for (r of getEditNodeResolvers(group.id); track r.name) {
                                <div class="resolver-priority-item">
                                  <span class="priority-label">{{ r.name }}</span>
                                  <input
                                    (ngModelChange)="setEditResolverPriority(group.id, r.name, $event)"
                                    [ngModel]="r.priority"
                                    class="resolver-priority-input"
                                    max="999"
                                    min="1"
                                    type="number" />
                                </div>
                              }
                            </div>
                          </mat-form-field>
                        </div>
                      }
                    </div>
                  } @else {
                    <div class="resolver-cell">
                      @if (element.resolverGroups.length === 0) {
                        <span i18n>No resolvers</span>
                      } @else {
                        @for (group of element.resolverGroups; track group.nodeLabel) {
                          <div class="resolver-node-group">
                            <div class="resolver-node-label">
                              <mat-icon
                                aria-hidden="true"
                                class="resolver-node-icon">
                                dns
                              </mat-icon>
                              <span>{{ group.nodeLabel }}</span>
                            </div>

                            <ul class="resolver-list">
                              @for (res of group.resolvers; track res.name + res.type + res.priority) {
                                <li class="resolver-item">
                                  <span class="resolver-name">{{ res.name }}</span>
                                  @if (res.priority !== null && res.priority !== undefined) {
                                    <span class="resolver-priority">[{{ res.priority }}]</span>
                                  }
                                  <span class="resolver-type">({{ res.type }})</span>
                                </li>
                              }
                            </ul>
                          </div>
                        }
                      }
                    </div>
                  }
                }
                @case ("actions") {
                  <div class="actions-buttons">
                    @if (editingRealmName() === element.name) {
                      <button
                        (click)="saveEditedRealm(element)"
                        [disabled]="!canSaveEditedRealm(element)"
                        aria-label="Save realm"
                        color="primary"
                        mat-icon-button
                        type="button">
                        <mat-icon>save_as</mat-icon>
                      </button>
                      <button
                        (click)="cancelEditRealm()"
                        aria-label="Cancel edit"
                        class="red"
                        mat-icon-button
                        type="button">
                        <mat-icon>cancel</mat-icon>
                      </button>
                    } @else {
                      <button
                        (click)="startEditRealm(element)"
                        aria-label="Edit realm"
                        mat-icon-button
                        type="button">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button
                        (click)="onDeleteRealm(element)"
                        aria-label="Delete realm"
                        color="warn"
                        mat-icon-button
                        type="button">
                        <mat-icon>delete</mat-icon>
                      </button>
                    }
                  </div>
                }
                @default {
                  <span>{{ element[column.key] }}</span>
                }
              }
            </td>

            <td
              *matFooterCellDef
              [ngClass]="{
                'width-18rem': column.key === 'resolvers',
                'actions-cell': column.key === 'actions'
              }"
              mat-footer-cell>
              <div>
                @switch (column.key) {
                  @case ("name") {
                    <mat-form-field
                      class="new-realm-name-field"
                      subscriptSizing="dynamic">
                      <mat-label i18n>Realm name</mat-label>
                      <input
                        (input)="newRealmName.set($any($event.target).value)"
                        [value]="newRealmName()"
                        matInput />
                    </mat-form-field>
                  }
                  @case ("resolvers") {
                    <div class="node-resolvers-groups">
                      @for (group of allNodeGroups(); track group.id) {
                        <div class="node-resolvers-group">
                          <div class="resolver-node-label">
                            <mat-icon
                              aria-hidden="true"
                              class="resolver-node-icon">
                              dns
                            </mat-icon>
                            <span>{{ group.label }}</span>
                          </div>

                          <mat-form-field
                            class="node-resolvers-select"
                            subscriptSizing="dynamic">
                            <mat-label i18n>Resolvers</mat-label>
                            <mat-select
                              (selectionChange)="onNewRealmNodeResolversChange(group.id, $event.value)"
                              [value]="getCreateNodeResolverNames(group.id)"
                              multiple>
                              @for (res of resolverOptions(); track res.name) {
                                <mat-option [value]="res.name">
                                  {{ res.name }} ({{ res.type }})
                                </mat-option>
                              }
                            </mat-select>
                          </mat-form-field>

                          <div class="resolver-priority-list">
                            @for (r of getCreateNodeResolvers(group.id); track r.name) {
                              <div class="resolver-priority-item">
                                <span class="priority-label">{{ r.name }}</span>
                                <input
                                  (ngModelChange)="setNewRealmResolverPriority(group.id, r.name, $event)"
                                  [ngModel]="r.priority"
                                  class="resolver-priority-input"
                                  max="999"
                                  min="1"
                                  type="number" />
                              </div>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  }
                  @case ("actions") {
                    <div class="actions-buttons">
                      <button
                        (click)="onCreateRealm()"
                        [disabled]="!canSubmitNewRealm()"
                        class="action-button-1 width-238"
                        mat-stroked-button
                        type="button">
                        <mat-icon>add</mat-icon>
                        <span i18n>Create</span>
                      </button>
                      <button
                        (click)="resetCreateForm()"
                        [disabled]="isCreatingRealm()"
                        mat-button
                        type="button">
                        <span i18n>Reset</span>
                      </button>
                    </div>
                  }
                  @default {
                    <span></span>
                  }
                }
              </div>
            </td>
          </ng-container>
        }

        <tr
          *matHeaderRowDef="columnKeys"
          aria-label="Header Row"
          mat-header-row></tr>

        <tr
          *matRowDef="let row; columns: columnKeys"
          aria-label="Data Row"
          mat-row></tr>

        <tr
          *matFooterRowDef="columnKeys"
          aria-label="Create Realm Footer Row"
          class="new-realm-footer-row"
          mat-footer-row></tr>

        <tr
          *matNoDataRow
          aria-label="No Data Row"
          mat-no-data-row>
          <td
            [attr.colspan]="columnKeys.length"
            aria-label="No Data Cell">
            No data matching the filter.
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>
