<div class="type-section">
  @if (type() === 'entraidresolver') {
    <h3 i18n>Entra ID settings</h3>
  } @else if (type() === 'keycloakresolver') {
    <h3 i18n>Keycloak settings</h3>
  } @else {
    <h3 i18n>HTTP settings</h3>
  }

  @if (!isAdvanced) {
    <mat-button-toggle-group
      (ngModelChange)="basicSettings.set($event)"
      [ngModel]="basicSettings()"
      class="mode-toggle">
      <mat-button-toggle
        [value]="true"
        i18n>Basic
      </mat-button-toggle>
      <mat-button-toggle
        [value]="false"
        i18n>Advanced
      </mat-button-toggle>
    </mat-button-toggle-group>

    <mat-divider class="margin-top-1 margin-bottom-1" />
  }

  @if (!isAdvanced && basicSettings()) {
    <div class="form-grid flex-column">
      <mat-form-field class="field-lg">
        <mat-label i18n>Endpoint (URL)</mat-label>
        <input
          [formControl]="endpointControl"
          matInput
          placeholder="https://example.com/path/to/users/:userid"
          required />
        @if (endpointControl.hasError('required') && endpointControl.touched) {
          <mat-error i18n>Endpoint is <strong>required</strong>.</mat-error>
        }
      </mat-form-field>

      <mat-form-field>
        <mat-label i18n>Method</mat-label>
        <mat-select
          [formControl]="methodControl"
          required>
          <mat-option value="GET">GET</mat-option>
          <mat-option value="POST">POST</mat-option>
        </mat-select>
        @if (methodControl.hasError('required') && methodControl.touched) {
          <mat-error i18n>Method is <strong>required</strong>.</mat-error>
        }
      </mat-form-field>

      <mat-form-field class="field-lg">
        <mat-label i18n>Request Mapping (JSON Format)</mat-label>
        <textarea
          [formControl]="requestMappingControl"
          matInput
          placeholder='{"customerid":"{userid}","accessKey":"secr3t!"}'
          required></textarea>
        @if (requestMappingControl.hasError('required') && requestMappingControl.touched) {
          <mat-error i18n>Request mapping is <strong>required</strong>.</mat-error>
        }
      </mat-form-field>

      <mat-form-field class="field-lg">
        <mat-label i18n>Headers (JSON Format)</mat-label>
        <textarea
          [formControl]="headersControl"
          matInput
          placeholder='{"Content-Type":"application/json; charset=UTF-8"}'
          required></textarea>
        @if (headersControl.hasError('required') && headersControl.touched) {
          <mat-error i18n>Headers are <strong>required</strong>.</mat-error>
        }
      </mat-form-field>

      <mat-form-field class="field-lg">
        <mat-label i18n>Response Mapping (JSON Format)</mat-label>
        <textarea
          [formControl]="responseMappingControl"
          matInput
          placeholder='{"username":"{Username}","email":"{Email}"}'
          required></textarea>
        @if (responseMappingControl.hasError('required') && responseMappingControl.touched) {
          <mat-error i18n>Response mapping is <strong>required</strong>.</mat-error>
        }
      </mat-form-field>
    </div>

    <mat-checkbox
      [formControl]="editableControl"
      class="checkbox-inline"
      i18n>
      Special Error Handling
    </mat-checkbox>

    @if (editableControl.value) {
      <mat-form-field class="field-lg width-100">
        <mat-label i18n>Response contains (JSON Format)</mat-label>
        <textarea
          [formControl]="errorResponseControl"
          matInput
          placeholder='{"success": false, "message": "An error occurred!"}'
          required></textarea>
        @if (errorResponseControl.hasError('required') && errorResponseControl.touched) {
          <mat-error i18n>Response contains is <strong>required</strong>.</mat-error>
        }
      </mat-form-field>
    }
  } @else {

    @if (type() === 'keycloakresolver') {
      <div class="form-grid">
        <mat-form-field>
          <mat-label i18n>Realm</mat-label>
          <input
            [formControl]="realmControl"
            matInput
            placeholder="master" />
        </mat-form-field>
      </div>
    }

    <div class="form-grid">
      <mat-form-field class="field-lg">
        <mat-label i18n>Base URL</mat-label>
        <input
          [formControl]="baseUrlControl"
          matInput
          placeholder="https://example.com/path/to/users"
          required />
        <mat-hint i18n>The base URL of the API of the user store which will be concatenated with the user endpoints
                       defined below.
        </mat-hint>
        @if (baseUrlControl.hasError('required') && baseUrlControl.touched) {
          <mat-error i18n>Base URL is <strong>required</strong>.</mat-error>
        }
      </mat-form-field>
    </div>

    <div class="mapping-header">
      <h4 i18n>Attribute Mapping</h4>
      <button
        (click)="addMappingRow()"
        mat-stroked-button
        type="button">
        <mat-icon>add</mat-icon>
        <span i18n>Add mapping</span>
      </button>
    </div>

    <table
      [dataSource]="mappingRows()"
      class="mapping-table"
      mat-table>

      <ng-container matColumnDef="privacyideaAttr">
        <th
          *matHeaderCellDef
          i18n
          mat-header-cell>PrivacyIDEA Attribute
        </th>
        <td
          *matCellDef="let row; let i = index"
          mat-cell>
          <mat-form-field
            class="cell-field"
            subscriptSizing="dynamic">
            <mat-select
              (selectionChange)="onPrivacyIdeaAttrChanged(i)"
              [(ngModel)]="row.privacyideaAttr"
              i18n-placeholder
              placeholder="Select PrivacyIDEA Attribute">

              @for (attr of availableAttributes()[i]; track attr) {
                <mat-option [value]="attr">{{ attr }}</mat-option>
              }

              <mat-divider></mat-divider>

              <mat-option
                [value]="CUSTOM_ATTR_VALUE"
                i18n>Customâ€¦
              </mat-option>
            </mat-select>
          </mat-form-field>

          @if (isCustomAttr(row.privacyideaAttr)) {
            <mat-form-field
              class="cell-field"
              subscriptSizing="dynamic">
              <input
                (ngModelChange)="setCustomAttr(i, $event)"
                [ngModel]="''"
                i18n-placeholder
                matInput
                placeholder="Enter custom attribute" />
            </mat-form-field>
          }
        </td>
      </ng-container>

      <ng-container matColumnDef="userStoreAttr">
        <th
          *matHeaderCellDef
          i18n
          mat-header-cell>User Store Attribute
        </th>
        <td
          *matCellDef="let row; let i = index"
          mat-cell>
          <mat-form-field
            class="cell-field"
            subscriptSizing="dynamic">
            <input
              (ngModelChange)="onMappingChanged()"
              [(ngModel)]="row.userStoreAttr"
              i18n-placeholder
              matInput
              placeholder="e.g. givenname" />
          </mat-form-field>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th
          *matHeaderCellDef
          i18n
          mat-header-cell>Actions
        </th>
        <td
          *matCellDef="let row; let i = index"
          class="actions-cell"
          mat-cell>
          <div class="actions-buttons">
            <button
              (click)="removeMappingRow(i)"
              aria-label="Remove mapping"
              color="warn"
              mat-icon-button
              type="button">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr
        *matHeaderRowDef="displayedColumns"
        mat-header-row></tr>
      <tr
        *matRowDef="let row; columns: displayedColumns"
        mat-row></tr>
    </table>

    <mat-hint i18n>
      The left column defines the user attributes used in privacyIDEA and the right column the equivalent attribute in
      the user store.
    </mat-hint>

    <div class="form-grid margin-top-1">
      <mat-form-field class="field-lg">
        <mat-label i18n>Headers (JSON Format)</mat-label>
        <textarea
          [formControl]="globalHeadersControl"
          matInput
          placeholder='{"Content-Type":"application/json; charset=UTF-8"}'></textarea>
        <mat-hint i18n>If no custom headers are defined this header is used for all endpoints.</mat-hint>
      </mat-form-field>

      <div class="flex-column">
        <mat-checkbox
          [formControl]="editableControl"
          i18n>
          Edit User Store
        </mat-checkbox>
        <span
          class="hint"
          i18n>The user data in this user store can be modified from within privacyIDEA.</span>
      </div>

      <div class="flex-column">
        <mat-checkbox
          [formControl]="verifyTlsControl"
          i18n>
          Verify TLS certificate of the server.
        </mat-checkbox>
      </div>

      @if (verifyTlsControl.value) {
        <mat-form-field class="field-lg">
          <mat-label i18n>CA certificate</mat-label>
          <mat-hint i18n>
            The file containing the CA certificate which signed the TLS certificate of the server.
          </mat-hint>
          <input
            [formControl]="tlsCaPathControl"
            matInput
            placeholder="/etc/privacyidea/ldap-ca.crt" />
        </mat-form-field>
      }

      <mat-form-field>
        <mat-label i18n>Timeout (seconds)</mat-label>
        <input
          [formControl]="timeoutControl"
          matInput
          placeholder="60" />
        <mat-hint i18n>Time in seconds privacyIDEA tries to reach the user store server.</mat-hint>
      </mat-form-field>
    </div>
    <div class="margin-top-1">
      <mat-accordion>
        <mat-expansion-panel [expanded]="isAuthorizationExpanded">
          <mat-expansion-panel-header>
            <mat-panel-title i18n>Authorization</mat-panel-title>
          </mat-expansion-panel-header>

          <div class="auth-panel-body">
            @if (type() === 'entraidresolver') {
              <p
                class="auth-description"
                i18n>
                This section allows to configure an endpoint to which the privacyIDEA server must authenticate in order
                to receive an access token. This token can then be used to access the user store API.

                You can find most of these settings in the app registration in the Entra Admin Center or you also have
                to add them there.
              </p>
              <div class="auth-grid">
                <mat-form-field class="auth-wide">
                  <mat-label i18n>Authority</mat-label>
                  <input
                    [formControl]="authorityControl"
                    matInput
                    placeholder="https://login.microsoftonline.com/{tenant}" />
                </mat-form-field>

                <mat-form-field>
                  <mat-label i18n>Tenant ID</mat-label>
                  <input
                    [formControl]="tenantControl"
                    matInput
                    placeholder="e.g. 12345678-1234-1234-1234-123456789012"
                    required />
                  @if (tenantControl.hasError('required') && tenantControl.touched) {
                    <mat-error i18n>Tenant ID is <strong>required</strong>.</mat-error>
                  }
                </mat-form-field>

                <mat-form-field>
                  <mat-label i18n>Client ID</mat-label>
                  <input
                    [formControl]="clientIdControl"
                    matInput
                    placeholder="e.g. 87654321-4321-4321-4321-210987654321"
                    required />
                  @if (clientIdControl.hasError('required') && clientIdControl.touched) {
                    <mat-error i18n>Client ID is <strong>required</strong>.</mat-error>
                  }
                </mat-form-field>

                <mat-form-field>
                  <mat-label i18n>Client Credential Type</mat-label>
                  <mat-select
                    [formControl]="clientCredentialTypeControl">
                    <mat-option value="secret">Secret</mat-option>
                    <mat-option value="certificate">Certificate</mat-option>
                  </mat-select>
                </mat-form-field>

                @if (clientCredentialTypeControl.value === 'secret') {
                  <mat-form-field>
                    <mat-label i18n>Client Secret</mat-label>
                    <input
                      [formControl]="clientSecretControl"
                      matInput
                      required
                      type="password" />
                    @if (clientSecretControl.hasError('required') && clientSecretControl.touched) {
                      <mat-error i18n>Client secret is <strong>required</strong>.</mat-error>
                    }
                  </mat-form-field>
                } @else if (clientCredentialTypeControl.value === 'certificate') {
                  <p
                    class="auth-description auth-wide"
                    i18n>
                    This credential type does not support to check the user's password.
                    <br>
                    <br>
                    Specify the path to the private key file of the servers certificate. If you use an encrypted key,
                    add the password here, otherwise leave the field empty. The server certificate must be uploaded in
                    Entra's app registration as client credential.
                  </p>

                  <div
                    [formGroup]="clientCertificateGroup"
                    class="auth-grid auth-wide">
                    <mat-form-field>
                      <mat-label i18n>Path to the private key file</mat-label>
                      <input
                        formControlName="private_key_file"
                        matInput
                        placeholder="/etc/privacyidea/entra.key" />
                    </mat-form-field>

                    <mat-form-field>
                      <mat-label i18n>Password for the private key</mat-label>
                      <input
                        formControlName="private_key_password"
                        matInput
                        type="password" />
                    </mat-form-field>

                    <mat-form-field>
                      <mat-label i18n>Thumbprint of the certificate</mat-label>
                      <input
                        formControlName="certificate_fingerprint"
                        matInput
                        placeholder="e.g. 1234567890ABCDEF1234567890ABCDEF12345678" />
                    </mat-form-field>
                  </div>
                }
              </div>
            } @else {
              <p
                class="auth-description"
                i18n>
                This section allows to configure an endpoint to which the privacyIDEA server must authenticate in order
                to receive an access token. This token can then be used to access the user store API.
              </p>

              <div class="auth-grid">
                <mat-form-field>
                  <mat-label i18n>Username</mat-label>
                  <input
                    [formControl]="usernameControl"
                    matInput
                    placeholder="privacyIDEA" />
                </mat-form-field>

                <mat-form-field>
                  <mat-label i18n>Password</mat-label>
                  <input
                    [formControl]="passwordControl"
                    matInput
                    placeholder="t0p_SeCr3t!"
                    type="password" />
                </mat-form-field>
              </div>

              <app-http-config
                [formGroup]="configAuthorizationGroup"
                [title]="'Authorization'" />
            }
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title i18n>Check User Password</mat-panel-title>
          </mat-expansion-panel-header>

          <div class="auth-panel-body">
            <app-http-config
              [description]="'Configure the endpoint to authenticate the user with its username/userid and password.'"
              [endpointHint]="'Possible tags: {userid} {username} {password}'"
              [formGroup]="configUserAuthGroup"
              [title]="'Check User Password'" />
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title i18n>User List</mat-panel-title>
          </mat-expansion-panel-header>

          <div class="auth-panel-body">
            <app-http-config
              [description]="'Configure the endpoint to retrieve a list of users from the user store. The above defined attributes are added to the request as search parameters if they are available in the request.'"
              [endpointHint]="'Possible tags: {userid} {username} {password} {givenname}'"
              [formGroup]="configGetUserListGroup"
              [title]="'User List'" />
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title i18n>Get User by ID</mat-panel-title>
          </mat-expansion-panel-header>

          <div class="auth-panel-body">
            <app-http-config
              [description]="'Configure the endpoint to retrieve a single user for the UID. For example, privacyIDEA only stores the UID of the token owner. To resolve the complete user, this endpoint is used.'"
              [endpointHint]="'Possible tags: {userid}'"
              [formGroup]="configGetUserByIdGroup"
              [title]="'Get User by ID'" />
          </div>
        </mat-expansion-panel>

        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title i18n>Get User by Name</mat-panel-title>
          </mat-expansion-panel-header>

          <div class="auth-panel-body">
            <app-http-config
              [description]="'Configure the endpoint to retrieve a single user for the username. For example, when a user tries to authenticate against privacyIDEA, only the username is provided. To resolve the complete user and evaluate if the user exists, this endpoint is used.'"
              [endpointHint]="'Possible tags: {username}'"
              [formGroup]="configGetUserByNameGroup"
              [title]="'Get User by Name'" />
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
  }
</div>