<!--
 (c) NetKnights GmbH 2025,  https://netknights.it

 This code is free software; you can redistribute it and/or
 modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
 as published by the Free Software Foundation; either
 version 3 of the License, or any later version.

 This code is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 GNU AFFERO GENERAL PUBLIC LICENSE for more details.

 You should have received a copy of the GNU Affero General Public
 License along with this program.  If not, see <http://www.gnu.org/licenses/>.

 SPDX-License-Identifier: AGPL-3.0-or-later
-->
<div
  appScrollToTop
  class="audit-table-container">
  <div class="filter-paginator-container audit-filter-paginator-container">
    <mat-form-field
      class="token-table-filter"
      subscriptSizing="dynamic">
      <mat-label i18n>Enter Filter</mat-label>
      <app-clearable-input
        (onClick)="auditService.clearFilter()"
        [showClearButton]="auditService.auditFilter().isNotEmpty">
        <input
          #filterHTMLInputElement
          (input)="auditService.handleFilterInput($event)"
          [value]="auditService.auditFilter().value"
          aria-label="Filter Input"
          i18n-aria-label
          i18n-placeholder
          matInput
          placeholder="Example query: 'type: hotp userid: 1000'" />
      </app-clearable-input>
    </mat-form-field>
    <mat-paginator
      (page)="onPageEvent($event)"
      [length]="totalLength()"
      [pageIndex]="auditService.pageIndex()"
      [pageSizeOptions]="pageSizeOptions()"
      [pageSize]="auditService.pageSize()"
      showFirstLastButtons></mat-paginator>
  </div>
  <app-keyword-filter #keywordFilterHTMLElement
                      [advancedApiFilter]="[]"
                      [apiFilter]="[]"
                      [filterHTMLInputElement]="filterHTMLInputElement"
                      [filterValue]="auditService.auditFilter" />
  <table
    [dataSource]="auditDataSource()"
    aria-label="Audit Data Table"
    class="token-table"
    i18n-aria-label
    mat-table>
    @for (column of columnKeysMap; track column) {
      <ng-container [matColumnDef]="column.key">
        <th
          *matHeaderCellDef
          attr.aria-label="{{ column.label }} Header"
          mat-header-cell>
          <div class="flex ali-center">
            {{ column.label }}
            @if (column.key !== 'number') {
              <button mat-fab
                      extended
                      (click)="keywordFilterHTMLElement.onKeywordClick(column.key)"
                      class="keyword-button audit-keyword-button">
                <mat-icon class="keyword-button-icon margin-left-0"
                          [ngClass]="{
                              change_circle: 'change-keyword',
                              remove_circle: 'remove-keyword',
                              add_circle: 'add-keyword',
                            }[keywordFilterHTMLElement.getFilterIconName(column.key)]">
                  {{ keywordFilterHTMLElement.getFilterIconName(column.key) }}
                </mat-icon>
              </button>
            }
          </div>
        </th>
        <td
          *matCellDef="let element; let row"
          attr.aria-label="{{ column.label }} Cell"
          mat-cell
          [ngClass]="{
            'width-18rem': column.key === 'description',
            'table-checkbox': column.key === 'select'
          }">
          <div>
            @switch (column.key) {
              @case ("success") {
                <div class="flex just-center">
                  <span
                    [ngClass]="
                      tableUtilsService.getSpanClassForKey({
                        key: column.key,
                        value: element[column.key]
                      })
                    ">
                    {{ element[column.key] }}
                  </span>
                </div>
              }
              @case ("serial") {
                <div class="flex-row ali-center">
                  <a
                    attr.aria-label="{{ column.label }} Link"
                    (click)="contentService.tokenSelected(element.serial)"
                    routerLink="/token">
                    {{ element[column.key] }}
                  </a>
                  @if (element.serial && element.serial !== "") {
                    <app-copy-button [copyText]="element.serial"></app-copy-button>
                  }
                </div>
              }
              @case (column.key === "sig_check" || column.key === "missing_line" ? column.key : "") {
                <span [ngClass]="[element[column.key] === 'OK' ? 'highlight-true' : 'highlight-false']">
                  {{ element[column.key] }}
                </span>
              }
              @case ("container_serial") {
                <div class="flex-row ali-center">
                  <a
                    attr.aria-label="{{ column.label }} Link"
                    (click)="contentService.containerSelected(element.container_serial)"
                    routerLink="/token">
                    {{ element[column.key] }}
                  </a>
                  @if (element.container_serial && element.container_serial !== "") {
                    <app-copy-button [copyText]="element.container_serial"></app-copy-button>
                  }
                </div>
              }
              @case ("startdate") {
                <span>
                  {{ element[column.key].split(".")[0].replace("T", " ") }}
                </span>
              }
              @case ("date") {
                <span>
                  {{ element[column.key].split(".")[0].replace("T", " ") }}
                </span>
              }
              @case ("policies") {
                @for (policy of element[column.key]?.split(","); track policy) {
                  <span>
                    {{ policy }}
                  </span>
                }
              }
              @case ("user") {
                <a
                  (click)="contentService.userSelected(element[column.key])"
                  attr.aria-label="{{ column.label }} Link">
                  {{ element[column.key] }}
                </a>
              }
              @default {
                <span>
                  {{ element[column.key] }}
                </span>
              }
            }
          </div>
        </td>
      </ng-container>
    }
    <tr
      *matHeaderRowDef="columnKeys"
      aria-label="Header Row"
      i18n-aria-label
      mat-header-row></tr>
    <tr
      *matRowDef="let row; columns: columnKeys"
      aria-label="Data Row"
      i18n-aria-label
      mat-row></tr>
    <tr
      *matNoDataRow
      aria-label="No Data Row"
      i18n-aria-label>
      <td
        [attr.colspan]="columnKeys.length"
        aria-label="No Data Cell"
        i18n
        i18n-aria-label>
        No data matching the filter.
      </td>
    </tr>
  </table>
</div>
