<!--
 (c) NetKnights GmbH 2026,  https://netknights.it

 This code is free software; you can redistribute it and/or
 modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
 as published by the Free Software Foundation; either
 version 3 of the License, or any later version.

 This code is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 GNU AFFERO GENERAL PUBLIC LICENSE for more details.

 You should have received a copy of the GNU Affero General Public
 License along with this program.  If not, see <http://www.gnu.org/licenses/>.

 SPDX-License-Identifier: AGPL-3.0-or-later
-->

<div class="conditions-container">
  <h2
    class="conditions-title"
    i18n>
    Additional Conditions
  </h2>

  @if (additionalConditions().length > 0) {
    <div class="additional-condition-header">
      <div class="center">Active</div>
      <div>Section</div>
      <div>Key</div>
      <div>Comparator</div>
      <div>Value</div>
      <div>Missing Data</div>
      <div class="center">Actions</div>
    </div>
  }

  <div class="additional-conditions-list">
    @for (condition of additionalConditions(); track $index) {
      <div
        class="additional-condition-row"
        [class.selected]="editIndex() === $index"
        (click)="editIndex() === $index ? cancelEdit() : startEditCondition(condition, $index)">
        <div class="center">
          <mat-slide-toggle
            #slideToggle
            [checked]="!condition[4]"
            (click)="$event.stopPropagation()"
            (change)="updateActiveState($index, $event.checked); slideToggle._switchElement.nativeElement.blur()">
          </mat-slide-toggle>
        </div>

        <div class="force-wrap">{{ getSectionLabel(condition[0]) }}</div>
        <strong class="force-wrap">{{ condition[1] }}</strong>
        <div class="force-wrap">{{ getComparatorLabel(condition[2]) }}</div>
        <strong class="force-wrap">{{ condition[3] }}</strong>
        <div class="missing-data-info force-wrap">{{ getMissingDataLabel(condition[5]) }}</div>

        <div class="center">
          <button
            mat-icon-button
            (click)="removeCondition($index); $event.stopPropagation()">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    }
  </div>

  @if (additionalConditions().length > 0) {
    <mat-divider class="divider-margin"></mat-divider>
  }

  @if (showAddConditionForm()) {
    <div class="new-condition-form">
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Section</mat-label>
          <mat-select [(ngModel)]="conditionSection">
            @for (option of SECTION_OPTIONS; track option.key) {
              <mat-option [value]="option.key">{{ option.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>If Data Missing</mat-label>
          <mat-select [(ngModel)]="conditionHandleMissingData">
            @for (opt of HANDLE_MISSING_DATA_OPTIONS; track opt.key) {
              <mat-option [value]="opt.key">{{ opt.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Key</mat-label>
          <input
            matInput
            [(ngModel)]="conditionKey" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Comparator</mat-label>
          <mat-select [(ngModel)]="conditionComparator">
            @for (opt of COMPARATOR_OPTIONS; track opt.key) {
              <mat-option [value]="opt.key">{{ opt.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Value</mat-label>
          <input
            matInput
            [(ngModel)]="conditionValue" />
        </mat-form-field>
      </div>

      <div class="form-actions">
        <button
          mat-button
          (click)="cancelEdit()"
          i18n>
          Cancel
        </button>
        <button
          mat-stroked-button
          color="primary"
          (click)="saveCondition()">
          @if (editIndex() !== null) {
            <span i18n>Update Condition</span>
          } @else {
            <span i18n>Add Condition</span>
          }
        </button>
      </div>
    </div>
  } @else {
    <div class="add-condition-button-container">
      <button
        mat-stroked-button
        class="action-button-1"
        (click)="showAddConditionForm.set(true)"
        color="primary">
        <mat-icon>add</mat-icon> <span i18n>Create a New Condition</span>
      </button>
    </div>
  }
</div>
