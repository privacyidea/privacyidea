<div class="additional-conditions-container">
  <h2
    class="additional-conditions-title"
    i18n>
    Additional Conditions
  </h2>

  @if (isEditMode()) {
    @if (additionalConditions().length > 0) {
      <div class="additional-condition-header">
        <div class="center">Active</div>
        <div>Section</div>
        <div>Key</div>
        <div>Comparator</div>
        <div>Value</div>
        <div>Missing Data</div>
        <div class="center">Actions</div>
      </div>
    }

    <div class="additional-conditions-list">
      @for (condition of additionalConditions(); track $index) {
        <div
          class="additional-condition-row"
          [class.selected]="editIndex() === $index"
          (click)="editIndex() === $index ? cancelEdit() : startEditCondition(condition, $index)">
          <div class="center">
            <mat-slide-toggle
              #slideToggle
              [checked]="!condition[4]"
              (click)="$event.stopPropagation()"
              (change)="updateActiveState($index, $event.checked); slideToggle._switchElement.nativeElement.blur()">
            </mat-slide-toggle>
          </div>

          <div class="force-wrap">{{ getSectionLabel(condition[0]) }}</div>
          <strong class="force-wrap">{{ condition[1] }}</strong>
          <div class="force-wrap">{{ getComparatorLabel(condition[2]) }}</div>
          <strong class="force-wrap">{{ condition[3] }}</strong>
          <div class="missing-data-info force-wrap">{{ getMissingDataLabel(condition[5]) }}</div>

          <div class="center">
            <button
              mat-icon-button
              (click)="removeCondition($index); $event.stopPropagation()">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      }
    </div>

    @if (additionalConditions().length > 0) {
      <mat-divider class="divider-margin"></mat-divider>
    }

    @if (showAddConditionForm()) {
      <div class="new-condition-form">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Section</mat-label>
            <mat-select
              [(ngModel)]="conditionSection"
              panelClass="auto-width-dropdown">
              @for (option of SECTION_OPTIONS; track option.key) {
                <mat-option [value]="option.key">{{ option.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>If Data Missing</mat-label>
            <mat-select
              [(ngModel)]="conditionHandleMissingData"
              panelClass="auto-width-dropdown">
              @for (opt of HANDLE_MISSING_DATA_OPTIONS; track opt.key) {
                <mat-option [value]="opt.key">{{ opt.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form-row">
          @if (conditionSection() === "token") {
            <mat-form-field appearance="outline">
              <mat-label>Token Key</mat-label>
              <input
                type="text"
                matInput
                [(ngModel)]="conditionKey"
                [matAutocomplete]="autoToken" />
              <mat-autocomplete #autoToken="matAutocomplete">
                @for (key of tokenKeysFiltered(); track key) {
                  <mat-option [value]="key">{{ key }}</mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>
          } @else if (conditionSection() === "container") {
            <mat-form-field appearance="outline">
              <mat-label>Container Key</mat-label>
              <input
                type="text"
                matInput
                [(ngModel)]="conditionKey"
                [matAutocomplete]="autoContainer" />
              <mat-autocomplete #autoContainer="matAutocomplete">
                @for (key of containerKeys; track key) {
                  <mat-option [value]="key">{{ key }}</mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>
          } @else {
            <mat-form-field appearance="outline">
              <mat-label>Key</mat-label>
              <input
                matInput
                [(ngModel)]="conditionKey" />
            </mat-form-field>
          }
          <mat-form-field appearance="outline">
            <mat-label>Comparator</mat-label>
            <mat-select
              [(ngModel)]="conditionComparator"
              panelClass="auto-width-dropdown">
              @for (opt of COMPARATOR_OPTIONS; track opt.key) {
                <mat-option [value]="opt.key">{{ opt.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Value</mat-label>
            <input
              matInput
              [(ngModel)]="conditionValue" />
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button
            mat-button
            (click)="cancelEdit()">
            Cancel
          </button>
          <button
            mat-raised-button
            color="primary"
            (click)="saveCondition()">
            {{ editIndex() !== null ? "Save Condition" : "Add Condition" }}
          </button>
        </div>
      </div>
    } @else {
      <div class="add-condition-button-container">
        <button
          mat-stroked-button
          (click)="showAddConditionForm.set(true)">
          <mat-icon>add</mat-icon> Create a New Condition
        </button>
      </div>
    }
  } @else {
    <div class="readonly-conditions-grid">
      @for (condition of additionalConditions(); track $index) {
        <div class="readonly-condition-item">
          <div class="status-row">
            <div class="active-status">
              <mat-icon [class.active]="!condition[4]">{{ !condition[4] ? "check_circle" : "cancel" }}</mat-icon>
            </div>
            <span class="readonly-badge">{{ getSectionLabel(condition[0]) }}</span>
          </div>

          <div class="data-row">
            <strong class="force-wrap">{{ condition[1] }}</strong>
            <span class="force-wrap">{{ getComparatorLabel(condition[2]) }}</span>
            <strong class="force-wrap">{{ condition[3] }}</strong>
            <span class="missing-data-info force-wrap">When Missing: {{ getMissingDataLabel(condition[5]) }}</span>
          </div>
        </div>
      }
    </div>
  }
</div>
