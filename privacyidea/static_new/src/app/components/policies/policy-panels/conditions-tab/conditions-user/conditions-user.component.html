<!--
 (c) NetKnights GmbH 2025,  https://netknights.it

 This code is free software; you can redistribute it and/or
 modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
 as published by the Free Software Foundation; either
 version 3 of the License, or any later version.

 This code is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 GNU AFFERO GENERAL PUBLIC LICENSE for more details.

 You should have received a copy of the GNU Affero General Public
 License along with this program.  If not, see <http://www.gnu.org/licenses/>.

 SPDX-License-Identifier: AGPL-3.0-or-later
-->
@if (isEditMode() || policyService.selectedPolicyHasUserConditions()) {
  <div class="user-container">
    <h2
      class="user-title"
      i18n>
      Users Conditions
    </h2>

    @if (isEditMode()) {
      <mat-form-field
        appearance="fill"
        class="full-width">
        <mat-label i18n>Select Realms</mat-label>
        <mat-select
          #realmSelect
          [value]="this.selectedRealms()"
          [multiple]="true"
          (selectionChange)="selectRealm($event.value)">
          <button
            mat-button
            class="toggle-all-button"
            (click)="toggleAllRealms()">
            {{ isAllRealmsSelected() ? "Deselect all" : "Select all" }}
          </button>
          @for (realmOption of this.realmService.realmOptions(); track $index) {
            <mat-option [value]="realmOption">{{ realmOption }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      @if (this.realmService.selectedRealms()) {
        <mat-form-field
          appearance="fill"
          class="full-width">
          <mat-label i18n>Select Resolvers</mat-label>
          <mat-select
            #resolverSelect
            [value]="this.selectedResolvers()"
            [multiple]="true"
            (selectionChange)="selectResolver($event.value)">
            <button
              mat-button
              class="toggle-all-button"
              (click)="toggleAllResolvers()">
              {{ isAllResolversSelected() ? "Deselect all" : "Select all" }}
            </button>
            @for (resolverOption of this.resolverService.resolverOptions(); track $index) {
              <mat-option [value]="resolverOption">{{ resolverOption }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      }

      <div class="user-list-wrapper">
        <div class="user-list">
          @for (user of selectedUsers(); track user) {
            <div class="user-chip">
              <span>{{ user }}</span>
              @if (isEditMode()) {
                <button
                  mat-icon-button
                  (click)="removeUser(user)"
                  class="remove-user-btn">
                  <mat-icon class="remove-user-icon">close</mat-icon>
                </button>
              }
            </div>
          }
        </div>
        @if (selectedUsers().length > 0) {
          <div class="user-buttons-container">
            <button
              mat-stroked-button
              class="case-insensitive-button button-hover"
              [class.button-active]="userCaseInsensitive()"
              (click)="toggleUserCaseInsensitive()">
              Case insensitive
            </button>
            <button
              mat-stroked-button
              class="clear-button"
              (click)="clearUsers()">
              Clear users
            </button>
          </div>
        }
      </div>
      <div class="user-input-container">
        <mat-form-field class="add-user-input">
          <mat-label i18n>Add User</mat-label>
          <input
            matInput
            [formControl]="userFormControl"
            #userInput
            (keyup.enter)="
              userFormControl.markAsTouched();
              addUser(userInput.value);
              !userFormControl.invalid && (userInput.value = '')
            " />
          @if (userFormControl.hasError("includesComma")) {
            <mat-error i18n> User must not contain commas. </mat-error>
          }
        </mat-form-field>
        <button
          class="add-user-button button-hover"
          [disabled]="!userInput.value.trim() || userFormControl.invalid"
          (click)="addUser(userInput.value); userInput.value = ''">
          <mat-icon>add</mat-icon>
        </button>
      </div>
    } @else {
      <div class="readonly-user-grid-container">
        @if (selectedRealms().length > 0) {
          <span
            class="readonly-label"
            i18n>
            Realms:
          </span>
          <div class="readonly-chips-container">
            @for (realm of selectedRealms(); track realm) {
              <div class="readonly-chip">{{ realm }}</div>
            }
          </div>
        }
        @if (selectedResolvers().length > 0) {
          <span
            class="readonly-label"
            i18n>
            Resolvers:
          </span>
          <div class="readonly-chips-container">
            @for (resolver of selectedResolvers(); track resolver) {
              <div class="readonly-chip">{{ resolver }}</div>
            }
          </div>
        }
        @if (selectedUsers().length > 0) {
          <span
            class="readonly-label"
            i18n>
            Users:
          </span>
          <div class="users-container">
            <div class="readonly-chips-container">
              @for (user of selectedUsers(); track user) {
                <div class="readonly-chip">{{ user }}</div>
              }
            </div>
            <div class="sensitivity-chip">
              @if (userCaseInsensitive()) {
                <span i18n>case-insensitive</span>
              } @else {
                <span i18n>case-sensitive</span>
              }
            </div>
          </div>
        }
      </div>
    }
  </div>
}
