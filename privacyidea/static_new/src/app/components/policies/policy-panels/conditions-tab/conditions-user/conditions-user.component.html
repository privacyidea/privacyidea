<mat-expansion-panel class="user-expansion-panel">
  <mat-expansion-panel-header>
    <mat-panel-title> Users </mat-panel-title>
  </mat-expansion-panel-header>

  <mat-form-field
    appearance="fill"
    class="full-width">
    <mat-label i18n>Select Realms</mat-label>
    <mat-select
      #realmSelect
      [value]="this.selectedRealms()"
      [multiple]="true"
      (selectionChange)="selectRealm($event.value)">
      <button
        mat-button
        class="toggle-all-button"
        (click)="toggleAllRealms()">
        {{ isAllRealmsSelected() ? "Deselect all" : "Select all" }}
      </button>
      @for (realmOption of this.realmService.realmOptions(); track $index) {
        <mat-option [value]="realmOption">{{ realmOption }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  @if (this.realmService.selectedRealms()) {
    <mat-form-field
      appearance="fill"
      class="full-width">
      <mat-label i18n>Select Resolvers</mat-label>
      <mat-select
        #resolverSelect
        [value]="this.selectedResolvers()"
        [multiple]="true"
        (selectionChange)="selectResolver($event.value)">
        <button
          mat-button
          class="toggle-all-button"
          (click)="toggleAllResolvers()">
          {{ isAllResolversSelected() ? "Deselect all" : "Select all" }}
        </button>
        @for (resolverOption of this.resolverService.resolverOptions(); track $index) {
          <mat-option [value]="resolverOption">{{ resolverOption }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
  }
  <div class="user-list-wrapper">
    <div class="user-list">
      @for (user of selectedUsers(); track user) {
        <div class="user-chip">
          <span>{{ user }}</span>
          <button
            mat-icon-button
            (click)="removeUser(user)"
            class="remove-user-btn">
            <mat-icon class="remove-user-icon">close</mat-icon>
          </button>
        </div>
      }
    </div>
    @if (selectedUsers().length > 0) {
      <div class="user-buttons-container">
        <button
          mat-stroked-button
          class="case-insensitive-button button-hover"
          [class.button-active]="userCaseInsensitive()"
          (click)="toggleUserCaseInsensitive()">
          Case insensitive
        </button>
        <button
          mat-stroked-button
          class="clear-button"
          (click)="clearUsers()">
          Clear users
        </button>
      </div>
    }
  </div>
  <div class="user-input-container">
    <mat-form-field class="add-user-input">
      <mat-label i18n>Add User</mat-label>
      <input
        matInput
        [formControl]="userFormControl"
        #userInput
        (keyup.enter)="
          userFormControl.markAsTouched();
          userFormControl.invalid ? null : (userInput.value = '');
          addUser(userInput.value)
        " />
      @if (userFormControl.hasError("includesComma")) {
        <mat-error i18n> User must not contain commas. </mat-error>
      }
    </mat-form-field>
    <button
      class="add-user-button button-hover"
      [disabled]="!userInput.value.trim() || userFormControl.invalid"
      (click)="addUser(userInput.value); userInput.value = ''">
      <mat-icon>add</mat-icon>
    </button>
  </div>
</mat-expansion-panel>
