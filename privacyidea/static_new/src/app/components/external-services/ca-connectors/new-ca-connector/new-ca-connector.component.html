<h2 mat-dialog-title>
  @if (isEditMode) {
    <span i18n>Edit CA Connector</span>
  } @else {
    <span i18n>Create CA Connector</span>
  }
</h2>

<mat-dialog-content>
  <form
    [formGroup]="caConnectorForm"
    class="ca-connector-column">
    <mat-form-field>
      <mat-label i18n>Connector name</mat-label>
      <input
        formControlName="connectorname"
        matInput
        placeholder="MyConnector1"
        required />
    </mat-form-field>

    <mat-form-field>
      <mat-label i18n>Type</mat-label>
      <mat-select
        formControlName="type"
        required>
        <mat-option
          i18n
          value="local">Local
        </mat-option>
        <mat-option
          i18n
          value="microsoft">Microsoft
        </mat-option>
      </mat-select>
    </mat-form-field>

    @if (caConnectorForm.get('type')?.value === 'local') {
      <h3 i18n>Base Config</h3>
      <mat-form-field>
        <mat-label i18n>CA Certificate</mat-label>
        <input
          formControlName="cacert"
          matInput
          placeholder="/etc/cacert.pem"
          required />
      </mat-form-field>

      <mat-form-field>
        <mat-label i18n>CA Key</mat-label>
        <input
          formControlName="cakey"
          matInput
          placeholder="/etc/cakey.pem"
          required />
      </mat-form-field>

      <mat-form-field>
        <mat-label i18n>OpenSSL config file</mat-label>
        <input
          formControlName="openssl.cnf"
          matInput
          placeholder="/etc/openssl.cnf"
          required />
      </mat-form-field>

      <mat-form-field>
        <mat-label i18n>Certificates Templates file</mat-label>
        <input
          formControlName="templates"
          matInput
          placeholder="/etc/privacyidea/ca/templates.yaml" />
      </mat-form-field>

      <mat-form-field>
        <mat-label i18n>Working Directory</mat-label>
        <input
          formControlName="WorkingDir"
          matInput
          placeholder="/opt/myCA" />
      </mat-form-field>

      <mat-form-field>
        <mat-label i18n>Certificate Signing Request Directory</mat-label>
        <input
          formControlName="CSRDir"
          matInput
          placeholder="/opt/myCA/csrs" />
      </mat-form-field>

      <mat-form-field>
        <mat-label i18n>Certificate Directory</mat-label>
        <input
          formControlName="CertificateDir"
          matInput
          placeholder="/opt/myCA/certs" />
        <mat-hint i18n>This is the directory where certificates get written to.</mat-hint>
      </mat-form-field>

      <h3 i18n>CRL Configuration</h3>
      <mat-form-field>
        <mat-label i18n>Certificate Revocation List</mat-label>
        <input
          formControlName="CRL"
          matInput
          placeholder="/opt/myCA/certs/crl.pem" />
        <mat-hint i18n>This is the CRL file, which is written when a certificate is revoked or the CRL is created
                       otherwise.
        </mat-hint>
      </mat-form-field>

      <div class="flex-row gap-1">
        <mat-form-field class="flex-1">
          <mat-label i18n>Validity Period</mat-label>
          <input
            formControlName="CRL_Validity_Period"
            matInput
            placeholder="30"
            type="number" />
          <mat-hint i18n>Number of days the generated CRL should be valid.</mat-hint>
        </mat-form-field>

        <mat-form-field class="flex-1">
          <mat-label i18n>Overlap Period</mat-label>
          <input
            formControlName="CRL_Overlap_Period"
            matInput
            placeholder="10"
            type="number" />
          <mat-hint i18n>Number of days a new CRL should be generated before the current CRL expires.</mat-hint>
        </mat-form-field>
      </div>
    } @else if (caConnectorForm.get('type')?.value === 'microsoft') {
      <h3 i18n>Base Config</h3>
      <mat-form-field>
        <mat-label i18n>Microsoft CA worker hostname</mat-label>
        <input
          formControlName="hostname"
          matInput
          placeholder="example.net"
          required />
      </mat-form-field>

      <mat-form-field>
        <mat-label i18n>Microsoft CA worker port</mat-label>
        <input
          formControlName="port"
          matInput
          placeholder="1234"
          required
          type="number" />
      </mat-form-field>

      <mat-checkbox
        formControlName="http_proxy"
        i18n>Use HTTP proxy
      </mat-checkbox>

      <h3 i18n>SSL Config</h3>
      <mat-checkbox
        formControlName="use_ssl"
        i18n>Use SSL
      </mat-checkbox>

      @if (caConnectorForm.get('use_ssl')?.value) {
        <mat-form-field>
          <mat-label i18n>CA certificate (filename)</mat-label>
          <input
            formControlName="ssl_ca_cert"
            matInput
            placeholder="/etc/privacyidea/ca/ca.crt" />
        </mat-form-field>

        <mat-form-field>
          <mat-label i18n>Client certificate (filename)</mat-label>
          <input
            formControlName="ssl_client_cert"
            matInput
            placeholder="/etc/privacyidea/ca/privacyidea.crt" />
        </mat-form-field>

        <mat-form-field>
          <mat-label i18n>Client private key (filename)</mat-label>
          <input
            formControlName="ssl_client_key"
            matInput
            placeholder="/etc/privacyidea/ca/privacyidea.key" />
        </mat-form-field>

        <mat-form-field>
          <mat-label i18n>Password of encrypted client private key</mat-label>
          <input
            formControlName="ssl_client_key_password"
            matInput
            placeholder="top secret"
            type="password" />
        </mat-form-field>
      }

      <div class="margin-top-1 margin-bottom-1">
        <button
          (click)="loadAvailableCas()"
          [disabled]="!caConnectorForm.get('hostname')?.value || !caConnectorForm.get('port')?.value || isLoadingCas()"
          class="action-button-1"
          mat-stroked-button>
          <mat-icon>assured_workload</mat-icon>
          <span i18n>Get available CAs</span>
        </button>
      </div>

      @if (availableCas().length > 0) {
        <mat-form-field>
          <mat-label i18n>Domain CA</mat-label>
          <mat-select
            formControlName="ca"
            required>
            @for (ca of availableCas(); track ca) {
              <mat-option [value]="ca">{{ ca }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      }
    }
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button
    (click)="onCancel()"
    i18n
    mat-button>Cancel
  </button>
  <button
    (click)="save()"
    [disabled]="caConnectorForm.invalid"
    class="action-button-1 width-238"
    i18n
    mat-stroked-button>
    <mat-icon>save</mat-icon>
    Save
  </button>
</mat-dialog-actions>
