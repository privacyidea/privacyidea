<!--
 (c) NetKnights GmbH 2025,  https://netknights.it

 This code is free software; you can redistribute it and/or
 modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
 as published by the Free Software Foundation; either
 version 3 of the License, or any later version.

 This code is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 GNU AFFERO GENERAL PUBLIC LICENSE for more details.

 You should have received a copy of the GNU Affero General Public
 License along with this program.  If not, see <http://www.gnu.org/licenses/>.

 SPDX-License-Identifier: AGPL-3.0-or-later
-->
<div
  appScrollToTop
  aria-label="Details"
  class="details-container"
  i18n-aria-label>
  <div class="details-flex-layout flex-column">
    <div class="container-details-header">
      <h3 i18n>Details for Container:</h3>
      <h3 class="container-serial">{{ containerSerial() }}</h3>
      <app-copy-button [copyText]="containerSerial()"></app-copy-button>
      @if (authService.actionAllowed("auditlog")) {
        <button
          (click)="showContainerAuditLog()"
          [routerLink]="[ROUTE_PATHS.AUDIT]"
          mat-icon-button
          matTooltip="Show container in audit log">
          <mat-icon>receipt_long</mat-icon>
        </button>
      }
    </div>
    <div
      [ngClass]="[overflowService.isWidthOverflowing('body', 1310) ? 'flex-column' : 'flex-row']"
      class="details-flex-layout">
      <div>
        <table
          [dataSource]="containerDetailData()"
          aria-label="Container Detail Data Table"
          class="details-table border-bottom-none"
          i18n-aria-label
          mat-table>
          <ng-container matColumnDef="key">
            <td
              *matCellDef="let element"
              class="details-key-row"
              mat-cell>
              {{ element.keyMap.label }}
            </td>
          </ng-container>
          <ng-container matColumnDef="value">
            <td
              *matCellDef="let element"
              [ngClass]="tableUtilsService.getTdClassForKey(element.keyMap.key)"
              class="fix-width-20-padr-0"
              mat-cell>
              @switch (element.keyMap.key) {
                @case ("states") {
                  @for (state of element.value; track state; let idx = $index) {
                    <span
                      class="font-14"
                      [ngClass]="[tableUtilsService.getSpanClassForState(state, false)]">
                      {{ tableUtilsService.getDisplayTextForState(state) }}
                    </span>
                  }
                }
                @case ("realms") {
                  @if (element.isEditing()) {
                    <mat-form-field class="width-18rem">
                      <mat-label i18n>Select Realms</mat-label>
                      <mat-select
                        [(ngModel)]="selectedRealms"
                        [value]="selectedRealms()"
                        multiple>
                        @for (option of realmService.realmOptions(); track option) {
                          @if (option === userRealm()) {
                            <mat-option
                              value="{{ option }}"
                              disabled>
                              {{ option }}
                            </mat-option>
                          } @else {
                            <mat-option value="{{ option }}">{{ option }}</mat-option>
                          }
                        }
                      </mat-select>
                    </mat-form-field>
                  } @else {
                    <div
                      class="details-scrollable-container"
                      [ngClass]="{ 'details-list': element.value.length > 2 }">
                      @for (realm of element.value; track realm; let idx = $index) {
                        <mat-list-item class="height-auto pad-0">
                          <span class="font-14">â€¢ {{ realm }}</span>
                        </mat-list-item>
                      }
                    </div>
                  }
                }
                @case ("description") {
                  @if (element.isEditing()) {
                    <mat-form-field class="width-288px description">
                      <textarea
                        matInput
                        rows="4"
                        [(ngModel)]="element.value"
                        i18n-placeholder
                        placeholder="Enter description"></textarea>
                    </mat-form-field>
                  } @else {
                    <div class="details-description-div">
                      <span class="details-table-item details-scrollable-container scroll-margin-pad">
                        {{ element.value }}
                      </span>
                    </div>
                  }
                }
                @default {
                  <span>{{ element.value }}</span>
                }
              }
            </td>
          </ng-container>
          <ng-container matColumnDef="edit">
            <td
              *matCellDef="let element"
              class="edit-column-cell"
              mat-cell>
              @if (isEditableElement(element.keyMap.key)) {
                <app-edit-buttons
                  [toggleEdit]="toggleContainerEdit.bind(this)"
                  [saveEdit]="saveContainerEdit.bind(this)"
                  [cancelEdit]="cancelContainerEdit.bind(this)"
                  [shouldHideEdit]="isAnyEditing"
                  [isEditingUser]="isEditingUser"
                  [isEditingInfo]="isEditingInfo"
                  [element]="element"></app-edit-buttons>
              }
            </td>
          </ng-container>
          <tr
            *matRowDef="let row; columns: ['key', 'value', 'edit']"
            class="height-52"
            mat-row></tr>
        </table>
        <table
          [dataSource]="userData()"
          aria-label="User Detail Data Table"
          class="details-table"
          i18n-aria-label
          mat-table>
          <ng-container matColumnDef="key">
            <td
              *matCellDef="let element"
              class="details-key-row"
              mat-cell>
              {{ element.keyMap.label }}
            </td>
          </ng-container>
          <ng-container matColumnDef="value">
            <td
              *matCellDef="let element"
              class="user-editable-row height-52 fix-width-20-padr-0"
              mat-cell>
              @switch (element.keyMap.key) {
                @case ("user_name") {
                  @if (isEditingUser() && userService.selectedUserRealm() !== "") {
                    <mat-form-field class="width-18rem">
                      <mat-label>Enter User</mat-label>
                      <app-clearable-input
                        (onClick)="userService.selectionFilter.set('')"
                        [showClearButton]="userService.selectionFilter() !== ''">
                        <input
                          matInput
                          [(ngModel)]="userService.selectionFilter"
                          [matAutocomplete]="userAuto" />
                        <mat-autocomplete
                          #userAuto="matAutocomplete"
                          class="user-selection-autocomplete">
                          @for (option of userService.selectionFilteredUsernames(); track option) {
                            <mat-option [value]="option">{{ option }}</mat-option>
                          }
                        </mat-autocomplete>
                      </app-clearable-input>
                    </mat-form-field>
                  } @else {
                    <a
                      (click)="contentService.userSelected(element.value, element['user_realm'])"
                      i18n-aria-label="{{ element.keyMap.label }} Link">
                      {{ element.value }}
                    </a>
                  }
                }
                @case ("user_realm") {
                  @if (isEditingUser()) {
                    <mat-form-field class="width-18rem">
                      <mat-label i18n>Select Realm of User</mat-label>
                      <mat-select
                        [(ngModel)]="userService.selectedUserRealm"
                        [value]="userService.selectedUserRealm()">
                        @for (option of realmService.realmOptions(); track option) {
                          <mat-option value="{{ option }}">{{ option }}</mat-option>
                        }
                      </mat-select>
                    </mat-form-field>
                  } @else {
                    <span>{{ element.value }}</span>
                  }
                }
                @default {
                  {{ element.value }}
                }
              }
            </td>
          </ng-container>

          <ng-container matColumnDef="edit">
            <td
              *matCellDef="let element"
              class="edit-column-cell"
              mat-cell>
              @if (authService.actionAllowed("container_unassign_user")) {
                @if (element.keyMap.key === "user_name" && !(isAnyEditing() && !isEditingUser())) {
                  @if (element.value) {
                    <div class="edit-button-container">
                      <button
                        mat-icon-button
                        class="yellow"
                        (click)="unassignUser()"
                        i18n-aria-label="Unassign User">
                        <mat-icon>person_remove</mat-icon>
                      </button>
                    </div>
                  } @else {
                    <app-edit-buttons
                      [toggleEdit]="toggleContainerEdit.bind(this)"
                      [saveEdit]="saveContainerEdit.bind(this)"
                      [cancelEdit]="cancelContainerEdit.bind(this)"
                      [shouldHideEdit]="isAnyEditing"
                      [isEditingUser]="isEditingUser"
                      [isEditingInfo]="isEditingInfo"
                      [element]="element"></app-edit-buttons>
                  }
                }
              }
            </td>
          </ng-container>
          <tr
            *matRowDef="let row; columns: ['key', 'value', 'edit']"
            mat-row></tr>
        </table>
        <div class="details-flex-layout">
          <app-container-details-info
            [detailData]="containerDetailData"
            [infoData]="infoData"
            [isAnyEditingOrRevoked]="isAnyEditing"
            [isEditingInfo]="isEditingInfo"
            [isEditingUser]="isEditingUser" />
        </div>
        @if (overflowService.isWidthOverflowing("body", 1310)) {
          <mat-divider class="margin-top-16 margin-bottom-16" />
        }
      </div>
      <div
        [ngClass]="[overflowService.isWidthOverflowing('body', 1310) ? '' : 'margin-left-1']"
        class="flex-column">
        <app-container-details-token-table [containerTokenData]="containerTokenData" />
        <div class="flex-row gap-32 margin-top-16">
          @if (authService.actionAllowed("container_add_token")) {
            <div class="flex-column">
              <h4 class="margin-left-1 margin-bottom-0">Add Token</h4>
              <div class="flex-row checkbox-paginator-container">
                <section>
                  <mat-checkbox
                    [(ngModel)]="showOnlyTokenNotInContainer"
                    class="pad-top-10">
                    <span i18n> Only display tokens that are not in a container </span>
                  </mat-checkbox>
                </section>
                <mat-paginator
                  (page)="onPageEvent($event)"
                  [hidePageSize]="true"
                  [length]="total()"
                  [pageIndex]="pageIndex()"
                  [pageSize]="pageSize()"></mat-paginator>
              </div>
              <mat-form-field class="add-token">
                <mat-label i18n>Add Token to Container</mat-label>
                <app-clearable-input
                  (onClick)="tokenService.clearFilter()"
                  [showClearButton]="tokenService.tokenFilter().isNotEmpty">
                  <input
                    #filterHTMLInputElement
                    #tokenAutoTrigger="matAutocompleteTrigger"
                    (input)="tokenService.handleFilterInput($event)"
                    [value]="tokenService.tokenFilter().filterString"
                    [matAutocomplete]="tokenAuto"
                    i18n-placeholder
                    matInput
                    placeholder="Example query: 'type: hotp serial: 123'" />
                </app-clearable-input>
                @if (!showOnlyTokenNotInContainer()) {
                  <mat-hint>
                    Adding a token removes it from its previous container
                  </mat-hint>
                }
                <mat-autocomplete #tokenAuto="matAutocomplete">
                  @for (option of tokenDataSource().data; track option) {
                    <mat-option
                      class="token-option"
                      (click)="addTokenToContainer(option)">
                      <span class="token-option-span"> {{ option["serial"] }} </span>
                      <span class="token-option-span">
                    {{ option["tokentype"] }}
                  </span>
                      <span
                        i18n
                        class="token-option-span"
                        [ngClass]="option['active'] ? 'highlight-true' : 'highlight-false'">
                    {{ option["active"] ? "active" : "deactivated" }}
                  </span>
                      <span class="token-option-span">
                    {{ option["username"] }}
                  </span>
                      <mat-icon>add</mat-icon>
                    </mat-option>
                  }
                </mat-autocomplete>
              </mat-form-field>
            </div>
          }
        </div>
      </div>
      <div
        [ngClass]="[overflowService.isWidthOverflowing('body', 1310) ? '' : 'margin-left-1']"
        class="flex-column gap-32 ali-center">
        <app-container-details-actions
          [containerSerial]="containerSerial()"
          [containerType]="containerType()"></app-container-details-actions>
        <app-container-details-token-actions
          [containerSerial]="containerSerial()"
          [user]="rawUserData"
          [tokenData]="containerTokenData"></app-container-details-token-actions>
      </div>
    </div>
  </div>
</div>
