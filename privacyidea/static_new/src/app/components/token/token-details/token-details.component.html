<div
  appScrollToTop
  aria-label="Details"
  class="details-container"
  i18n-aria-label>
  <div class="details-flex-layout flex-column">
    <div class="details-header">
      <h3 i18n>Details for Token:</h3>
      <h3 style="color: var(--mat-sys-primary)">{{ tokenSerial() }}</h3>
      @if ((tokenType() === "passkey" || tokenType() === "hotp") && isAttachedToMachine()) {
        <h3 i18n>{{ " (Offline)" }}</h3>
      }
      <app-copy-button [copyText]="tokenSerial()"></app-copy-button>
    </div>
    <div
      [ngClass]="[overflowService.isWidthOverflowing('body', 1310) ? 'flex-column' : 'flex-row']"
      class="details-flex-layout">
      <div>
        <table
          [dataSource]="tokenDetailData()"
          aria-label="Token Details Data Table"
          class="details-table"
          i18n-aria-label
          mat-table>
          <ng-container matColumnDef="key">
            <td
              *matCellDef="let element"
              class="details-key-row"
              mat-cell>
              {{ element.keyMap.label }}
            </td>
          </ng-container>
          <ng-container matColumnDef="value">
            <td
              *matCellDef="let element"
              [ngClass]="tableUtilsService.getTdClassForKey(element.keyMap.key)"
              mat-cell>
              @switch (element.keyMap.key) {
                @case ("container_serial") {
                  @if (element.isEditing()) {
                    <mat-form-field class="width-18rem container-form-field">
                      <mat-label i18n>Enter Container</mat-label>
                      <app-clearable-input
                        (onClick)="containerService.selectedContainer.set(null)"
                        [showClearButton]="containerService.selectedContainer() !== ''">
                        <input
                          matInput
                          [(ngModel)]="containerService.selectedContainer"
                          [matAutocomplete]="containerAuto" />
                      </app-clearable-input>
                      <mat-autocomplete #containerAuto="matAutocomplete">
                        @for (option of containerService.filteredContainerOptions(); track option) {
                          <mat-option [value]="option">{{ option }}</mat-option>
                        }
                      </mat-autocomplete>
                    </mat-form-field>
                  } @else {
                    <a
                      attr.aria-label="{{ element.keyMap.label }} Link"
                      (click)="contentService.containerSelected(element.value)">
                      {{ element.value }}
                    </a>
                    @if (element.value !== "") {
                      <app-copy-button [copyText]="element.value"></app-copy-button>
                    }
                  }
                }
                @case ("realms") {
                  @if (element.isEditing()) {
                    <mat-form-field class="width-18rem">
                      <mat-label i18n>Select Realms</mat-label>
                      <mat-select
                        [(ngModel)]="realmService.selectedRealms"
                        [value]="realmService.selectedRealms()"
                        multiple>
                        @for (option of realmService.realmOptions(); track option) {
                          @if (option === userRealm) {
                            <mat-option
                              value="{{ option }}"
                              disabled
                              >{{ option }}
                            </mat-option>
                          } @else {
                            <mat-option value="{{ option }}">{{ option }}</mat-option>
                          }
                        }
                      </mat-select>
                    </mat-form-field>
                  } @else {
                    <div
                      class="details-scrollable-container"
                      [ngClass]="{ 'details-list': element.value.length > 2 }">
                      @for (realm of element.value; track realm) {
                        <mat-list-item class="height-auto">
                          <span class="font-14">• {{ realm }}</span>
                        </mat-list-item>
                      }
                    </div>
                  }
                }
                @case ("tokengroup") {
                  @if (element.isEditing()) {
                    <mat-form-field class="width-18rem">
                      <mat-label i18n>Select Token Group</mat-label>
                      <mat-select
                        [(ngModel)]="selectedTokengroup"
                        [value]="selectedTokengroup()"
                        multiple>
                        @for (option of tokengroupOptions(); track option) {
                          @if (option === userRealm) {
                            <mat-option
                              value="{{ option }}"
                              disabled
                              >{{ option }}
                            </mat-option>
                          } @else {
                            <mat-option value="{{ option }}">{{ option }}</mat-option>
                          }
                        }
                      </mat-select>
                    </mat-form-field>
                  } @else {
                    <div
                      [ngClass]="{
                        'details-scrollable-container': true,
                        'details-list': element.value.length > 2
                      }">
                      @for (tokengroup of element.value; track tokengroup) {
                        <mat-list-item class="height-auto">
                          <span class="font-14">• {{ tokengroup }}</span>
                        </mat-list-item>
                      }
                    </div>
                  }
                }
                @case ("description") {
                  @if (element.isEditing()) {
                    <mat-form-field class="width-18rem description">
                      <textarea
                        matInput
                        rows="4"
                        [maxlength]="80"
                        [(ngModel)]="element.value"
                        i18n-placeholder
                        placeholder="Enter description"></textarea>
                    </mat-form-field>
                  } @else {
                    <div class="details-description-div">
                      <span class="details-table-item">
                        {{ element.value }}
                      </span>
                    </div>
                  }
                }
                @default {
                  @if (element.isEditing() && isNumberElement(element.keyMap.key)) {
                    <mat-form-field class="width-18rem">
                      <input
                        type="number"
                        matInput
                        [(ngModel)]="element.value" />
                    </mat-form-field>
                  } @else if (element.isEditing()) {
                    <mat-form-field class="width-18rem">
                      <textarea
                        matInput
                        rows="1"
                        [(ngModel)]="element.value"></textarea>
                    </mat-form-field>
                  } @else {
                    <div [ngClass]="[tableUtilsService.getDivClassForKey(element.keyMap.key)]">
                      <span
                        [ngClass]="[
                          tableUtilsService.getSpanClassForKey({
                            key: element.keyMap.key,
                            value: element.value,
                            maxfail: maxfail
                          })
                        ]">
                        {{
                          tableUtilsService.getDisplayTextForKeyAndRevoked(
                            element.keyMap.key,
                            element.value,
                            tokenIsRevoked()
                          )
                        }}
                      </span>
                    </div>
                  }
                }
              }
            </td>
          </ng-container>
          <ng-container matColumnDef="edit">
            <td
              *matCellDef="let element"
              class="edit-column-cell"
              mat-cell>
              <div class="ali-center">
                @if (
                  element.keyMap.key === "failcount" && !isAnyEditingOrRevoked() && authService.actionAllowed("reset")
                ) {
                  <div class="edit-button-container">
                    <button
                      mat-icon-button
                      (click)="resetFailCount()"
                      i18n-aria-label="Reset Fail Count">
                      <mat-icon> lock_reset</mat-icon>
                    </button>
                  </div>
                } @else if (
                  element.keyMap.key === "container_serial" &&
                  !isAnyEditingOrRevoked() &&
                  element.value &&
                  authService.actionAllowed("container_remove_token")
                ) {
                  <div class="edit-button-container">
                    <button
                      mat-icon-button
                      class="red"
                      (click)="deleteContainer()"
                      i18n-aria-label="Delete Container">
                      <mat-icon>folder_delete</mat-icon>
                    </button>
                  </div>
                } @else if (isEditableElement(element.keyMap.key)) {
                  <app-edit-buttons
                    [toggleEdit]="toggleTokenEdit.bind(this)"
                    [saveEdit]="saveTokenEdit.bind(this)"
                    [cancelEdit]="cancelTokenEdit.bind(this)"
                    [shouldHideEdit]="isAnyEditingOrRevoked"
                    [isEditingUser]="isEditingUser"
                    [isEditingInfo]="isEditingInfo"
                    [element]="element"></app-edit-buttons>
                }
              </div>
            </td>
          </ng-container>
          <tr
            *matRowDef="let row; columns: ['key', 'value', 'edit']"
            class="height-52"
            mat-row></tr>
        </table>
      </div>
      <div [ngClass]="[overflowService.isWidthOverflowing('.token-layout', 1580) ? 'flex-column' : 'flex-row']">
        <div class="flex-column">
          <app-token-details-user
            [isAnyEditingOrRevoked]="isAnyEditingOrRevoked"
            [isEditingInfo]="isEditingInfo"
            [isEditingUser]="isEditingUser"
            [tokenSerial]="tokenSerial"
            [userData]="userData"
            class="flex"></app-token-details-user>
          <app-token-details-info
            [detailData]="tokenDetailData"
            [infoData]="infoData"
            [isAnyEditingOrRevoked]="isAnyEditingOrRevoked"
            [isEditingInfo]="isEditingInfo"
            [isEditingUser]="isEditingUser"></app-token-details-info>
          @if (tokenType() === "sshkey" || tokenType() === "hotp") {
            <app-token-details-machine />
          }
        </div>
        <app-token-details-actions
          [repeatPinValue]="repeatPinValue"
          [setPinValue]="setPinValue"
          [tokenType]="tokenType"></app-token-details-actions>
      </div>
    </div>
  </div>
</div>
