<!--
 (c) NetKnights GmbH 2025,  https://netknights.it

 This code is free software; you can redistribute it and/or
 modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
 as published by the Free Software Foundation; either
 version 3 of the License, or any later version.

 This code is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 GNU AFFERO GENERAL PUBLIC LICENSE for more details.

 You should have received a copy of the GNU Affero General Public
 License along with this program.  If not, see <http://www.gnu.org/licenses/>.

 SPDX-License-Identifier: AGPL-3.0-or-later
-->
<div
  appScrollToTop
  aria-label="Token Table"
  class="token-table-layout"
  i18n-aria-label>
  <div class="selfservice-paginator-container">
    <h3
      class="selfservice-paginator-label"
      i18n>
      Your Tokens
    </h3>
    <mat-paginator
      (page)="onPageEvent($event)"
      [length]="totalLength()"
      [pageIndex]="pageIndex()"
      [pageSize]="pageSize()"
      hidePageSize
      showFirstLastButtons />
  </div>
  <div class="self-service-table-container">
    <table
      [dataSource]="tokenDataSource()"
      aria-label="Token Data Table"
      class="token-table"
      i18n-aria-label
      mat-table>
      @for (column of columnKeysMapSelfService(); track column) {
        <ng-container [matColumnDef]="column.key">
          <th
            *matHeaderCellDef
            attr.aria-label="{{ column.label }} Header"
            mat-header-cell>
            <div class="flex ali-center">
              {{ column.label }}
              <div class="margin-left-1 flex">
                <button
                  (click)="tableUtilsService.onSortButtonClick(column.key, sort)"
                  class="sort-button"
                  mat-icon-button
                  type="button">
                  <mat-icon>{{ tableUtilsService.getSortIcon(column.key, sort()) }}</mat-icon>
                </button>
              </div>
            </div>
          </th>
          <td
            *matCellDef="let element; let row"
            attr.aria-label="{{ column.label }} Cell"
            mat-cell
            [ngClass]="{ 'width-18rem': column.key === 'description' }">
            <div
              [ngClass]="tableUtilsService.getClassForColumnKey(column.key)">
              <div [ngClass]="tableUtilsService.getChildClassForColumnKey(column.key)">
                @switch (column.key) {
                  @case ("serial") {
                    <div class="flex-row ali-center">
                      <a
                        attr.aria-label="{{ column.label }} Link"
                        (click)="contentService.tokenSelected(element.serial)">
                        {{ element[column.key] }}
                      </a>
                      <app-copy-button [copyText]="element.serial" />
                    </div>
                  }
                  @case ("container_serial") {
                    <div class="flex-row ali-center">
                      @if (containerService.containerBelongsToUser(element.container_serial)) {
                        <a
                          attr.aria-label="{{ column.label }} Link"
                          (click)="contentService.containerSelected(element.container_serial)">
                          {{ element[column.key] }}
                        </a>
                      } @else {
                        {{ element[column.key] }}
                      }
                      @if (element.container_serial !== "") {
                        <app-copy-button [copyText]="element.container_serial" />
                      }
                    </div>
                  }
                  @case ("active") {
                    @if (authService.actionAllowed("enable") && authService.actionAllowed("disable")) {
                      <span
                        (click)="toggleActive(element)"
                        [matTooltip]="tableUtilsService.getTooltipForColumn(column.key,element)"
                        [ngClass]="tableUtilsService.getClassForColumn(column.key, element)">
                      {{ tableUtilsService.getDisplayText(column.key, element) }}
                    </span>
                    } @else {
                      <span [ngClass]="tableUtilsService.getClassForColumn(column.key, element)">
                          {{ tableUtilsService.getDisplayText(column.key, element) }}
                        </span>
                    }
                  }
                  @case ("failcount") {
                    @if (authService.actionAllowed("reset")) {
                      <span
                        (click)="resetFailCount(element)"
                        [ngClass]="tableUtilsService.getClassForColumn(column.key, element)">
                      {{ tableUtilsService.getDisplayText(column.key, element) }}
                    </span>
                    } @else {
                      <span [ngClass]="tableUtilsService.getClassForColumn(column.key, element)">
                          {{ tableUtilsService.getDisplayText(column.key, element) }}
                        </span>
                    }
                  }
                  @case ("revoke") {
                    @if (!element.revoked) {
                      <button
                        (click)="revokeToken(element.serial)"
                        mat-icon-button
                        i18n-matTooltip
                        matTooltip="Revoke Token">
                        <mat-icon> undo</mat-icon>
                      </button>
                    }
                  }
                  @case ("delete") {
                    <button
                      (click)="deleteToken(element.serial)"
                      mat-icon-button
                      i18n-matTooltip
                      matTooltip="Delete Token">
                      <mat-icon> delete</mat-icon>
                    </button>
                  }
                  @default {
                    @if (tableUtilsService.isLink(column.key)) {
                      <a
                        attr.aria-label="{{ column.label }} Link"
                        href="#">
                        {{ element[column.key] }}
                      </a>
                    } @else {
                      <span>
                          {{ element[column.key] }}
                        </span>
                    }
                  }
                }
              </div>
            </div>
          </td>
        </ng-container>
      }
      <tr
        *matHeaderRowDef="columnKeysSelfService"
        aria-label="Header Row"
        i18n-aria-label
        mat-header-row></tr>
      <tr
        *matRowDef="let row; columns: columnKeysSelfService"
        aria-label="Data Row"
        i18n-aria-label
        mat-row></tr>
      <tr
        *matNoDataRow
        aria-label="No Data Row"
        i18n-aria-label>
        <td
          [attr.colspan]="columnKeysSelfService.length"
          aria-label="No Data Cell"
          i18n
          i18n-aria-label>
          No data matching the filter.
        </td>
      </tr>
    </table>
  </div>
</div>
