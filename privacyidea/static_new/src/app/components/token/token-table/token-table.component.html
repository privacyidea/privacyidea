<!--
 (c) NetKnights GmbH 2025,  https://netknights.it

 This code is free software; you can redistribute it and/or
 modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
 as published by the Free Software Foundation; either
 version 3 of the License, or any later version.

 This code is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 GNU AFFERO GENERAL PUBLIC LICENSE for more details.

 You should have received a copy of the GNU Affero General Public
 License along with this program.  If not, see <http://www.gnu.org/licenses/>.

 SPDX-License-Identifier: AGPL-3.0-or-later
-->
<div
  appScrollToTop
  aria-label="Token Table"
  class="token-table-layout"
  i18n-aria-label>
  @if (authService.actionAllowed("tokenlist")) {
    <div class="filter-paginator-container">
      <mat-form-field
        class="token-table-filter"
        subscriptSizing="dynamic">
        <mat-label i18n>Filter Tokens...</mat-label>
        <app-clearable-input
          (onClick)="tokenService.clearFilter()"
          [showClearButton]="tokenService.tokenFilter().isNotEmpty">
          <input
            #filterHTMLInputElement
            (input)="tokenService.handleFilterInput($event)"
            [value]="tokenService.tokenFilter().filterString"
            aria-label="Filter Input"
            i18n-aria-label
            i18n-placeholder
            matInput
            placeholder="Example query: 'type: hotp userid: 1000'" />
        </app-clearable-input>
      </mat-form-field>
      <mat-paginator
        (page)="onPageEvent($event)"
        [length]="totalLength()"
        [pageIndex]="pageIndex()"
        [pageSizeOptions]="pageSizeOptions()"
        [pageSize]="pageSize()"
        showFirstLastButtons />
    </div>
    <div class="table-keyword-filter-row">
      <app-keyword-filter
        [advancedApiFilter]="advancedApiFilter"
        [apiFilter]="apiFilter"
        [filterHTMLInputElement]="filterHTMLInputElement"
        [filterValue]="tokenService.tokenFilter" />
    </div>
    <app-token-table-actions />
    <div class="table-container">
      <table
        (matSortChange)="onSortEvent($event)"
        [dataSource]="tokenDataSource()"
        aria-label="Token Data Table"
        class="token-table"
        i18n-aria-label
        mat-table
        matSort>
        @for (column of columnKeysMap; track column) {
          <ng-container [matColumnDef]="column.key">
            @if (column.key === "select") {
              <th
                *matHeaderCellDef
                class="table-checkbox"
                mat-header-cell>
                <mat-checkbox
                  (change)="$event ? toggleAllRows() : null"
                  [checked]="isAllSelected()"
                  [disabled]="totalLength() === 0"
                  [indeterminate]="tokenSelection().length > 0 && !isAllSelected()" />
              </th>
            } @else {
              <th
                *matHeaderCellDef
                attr.aria-label="{{ column.label }} Header"
                mat-header-cell
                mat-sort-header>
                {{ column.label }}
              </th>
            }
            <td
              *matCellDef="let tokenDetails"
              [ngClass]="{
                'width-18rem': column.key === 'description',
                'table-checkbox': column.key === 'select'
              }"
              attr.aria-label="{{ column.label }} Cell"
              mat-cell>
              <div [ngClass]="tableUtilsService.getClassForColumnKey(column.key)">
                @switch (column.key) {
                  @case ("select") {
                    <mat-checkbox
                      (change)="$event ? toggleRow(tokenDetails) : null"
                      (click)="$event.stopPropagation()"
                      [checked]="tokenSelection().includes(tokenDetails)"
                      [disabled]="totalLength() === 0" />
                  }
                  @case ("serial") {
                    <div class="flex-row">
                      <a
                        (click)="contentService.tokenSelected(tokenDetails.serial)"
                        attr.aria-label="{{ column.label }} Link"
                        class="flex ali-center">
                        {{ tokenDetails[column.key] }}
                      </a>
                      <app-copy-button [copyText]="tokenDetails.serial" />
                    </div>
                  }
                  @case ("active") {
                    @if (authService.actionAllowed("enable") && authService.actionAllowed("disable")) {
                      <span
                        (click)="toggleActive(tokenDetails)"
                        [ngClass]="tableUtilsService.getClassForColumn(column.key, tokenDetails)">
                      {{ tableUtilsService.getDisplayText(column.key, tokenDetails) }}
                    </span>
                    }
                  }
                  @case ("failcount") {
                    @if (authService.actionAllowed("reset")) {
                      <span
                        (click)="resetFailCount(tokenDetails)"
                        [ngClass]="tableUtilsService.getClassForColumn(column.key, tokenDetails)">
                      {{ tableUtilsService.getDisplayText(column.key, tokenDetails) }}
                    </span>
                    }
                  }
                  @case ("realms") {
                    <div [ngClass]="{ 'realm-list': (tokenDetails[column.key]?.length || 0) > 1 }">
                      @for (realm of tokenDetails[column.key]; track realm; let idx = $index) {
                        <span attr.aria-label="{{ column.label }} Link">
                          {{ realm }}
                        </span>
                        <br class="realm-break" />
                      }
                    </div>
                  }
                  @case ("container_serial") {
                    <a
                      (click)="contentService.containerSelected(tokenDetails.container_serial)"
                      attr.aria-label="{{ column.label }} Link">
                      {{ tokenDetails[column.key] }}
                    </a>
                    @if (tokenDetails.container_serial !== "") {
                      <app-copy-button [copyText]="tokenDetails.container_serial" />
                    }
                  }
                  @case ("username") {
                    <a
                      (click)="contentService.userSelected(tokenDetails[column.key])"
                      attr.aria-label="{{ column.label }} Link">
                      {{ tokenDetails[column.key] }}
                    </a>
                  }
                  @default {
                    @if (tableUtilsService.isLink(column.key)) {
                      <a
                        attr.aria-label="{{ column.label }} Link"
                        href="#">
                        {{ tokenDetails[column.key] }}
                      </a>
                    } @else {
                      <span>
                        {{ tokenDetails[column.key] }}
                      </span>
                    }
                  }
                }
              </div>
            </td>
          </ng-container>
        }
        <tr
          *matHeaderRowDef="columnKeys"
          aria-label="Header Row"
          i18n-aria-label
          mat-header-row></tr>

        <tr
          *matRowDef="let row; columns: columnKeys"
          aria-label="Data Row"
          i18n-aria-label
          mat-row></tr>

        <tr
          *matNoDataRow
          aria-label="No Data Row"
          i18n-aria-label>
          <td
            [attr.colspan]="columnKeys.length"
            aria-label="No Data Cell"
            i18n
            i18n-aria-label>
            No data matching the filter.
          </td>
        </tr>
      </table>
    </div>
  } @else {
    <div i18n>You do not have the permission to view the token list.</div>
  }
</div>
