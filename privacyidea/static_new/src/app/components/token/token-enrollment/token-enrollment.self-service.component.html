<!--
 (c) NetKnights GmbH 2025,  https://netknights.it

 This code is free software; you can redistribute it and/or
 modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
 as published by the Free Software Foundation; either
 version 3 of the License, or any later version.

 This code is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 GNU AFFERO GENERAL PUBLIC LICENSE for more details.

 You should have received a copy of the GNU Affero General Public
 License along with this program.  If not, see <http://www.gnu.org/licenses/>.

 SPDX-License-Identifier: AGPL-3.0-or-later
-->
<div
  #scrollContainer
  appScrollToTop
  aria-label="Token Enrollment"
  class="token-enrollment-container">
  <h3 class="margin-left-1">Enroll a New Token</h3>
  <form
    (ngSubmit)="enrollToken()"
    [formGroup]="formGroupSignal()">
    <div #stickySentinel></div>
    <div
      #stickyHeader
      class="sticky-header">
      <div class="sticky-controls ali-center">
        <div class="select-token-type-container">
          <mat-form-field
            class="width-100"
            subscriptSizing="dynamic">
            <mat-select
              [(ngModel)]="tokenService.selectedTokenType"
              [ngModelOptions]="{ standalone: true }"
              [panelClass]="'multi-column-panel'"
              [value]="tokenService.selectedTokenType()">
              @for (type of tokenService.tokenTypeOptions(); track type) {
                <mat-option
                  class="select-option"
                  [value]="type"
                  [matTooltip]="type.info.split(':')[1]">
                  {{ type.info.split(":")[0] }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
        <div class="enroll-button-container">
          <button
            [disabled]="!tokenService.selectedTokenType()"
            class="action-button-1 width-238"
            mat-stroked-button
            type="submit">
            <mat-icon>add</mat-icon>
            Enroll
          </button>
          <button
            (click)="reopenEnrollmentDialog()"
            [matTooltip]="'Reopen enrollment dialog'"
            [ngClass]="{ hidden: !canReopenEnrollmentDialog() }"
            mat-icon-button
            type="button">
            <mat-icon>open_in_new</mat-icon>
          </button>
        </div>
      </div>
    </div>
    <div class="token-type-paragraph">
      <p>{{ tokenTypeDescription() }}</p>
    </div>
    @switch (tokenService.selectedTokenType().key) {
      @case ("hotp") {
        <app-enroll-hotp
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("totp") {
        <app-enroll-totp
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("spass") {
        <app-enroll-spass
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("motp") {
        <app-enroll-motp
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("sshkey") {
        <app-enroll-sshkey
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("yubikey") {
        <app-enroll-yubikey
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("remote") {
        <app-enroll-remote
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("yubico") {
        <app-enroll-yubico
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("radius") {
        <app-enroll-radius
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("sms") {
        <app-enroll-sms
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("4eyes") {
        <app-enroll-foureyes
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("applspec") {
        <app-enroll-applspec
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("daypassword") {
        <app-enroll-daypassword
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("certificate") {
        <app-enroll-certificate
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("email") {
        <app-enroll-email
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("indexedsecret") {
        <app-enroll-indexedsecret
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("paper") {
        <app-enroll-paper
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("push") {
        <app-enroll-push
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)"
          (reopenDialogChange)="updateReopenDialog($event)" />
      }
      @case ("question") {
        <app-enroll-question
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("registration") {
        <app-enroll-registration
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("tan") {
        <app-enroll-tan
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("tiqr") {
        <app-enroll-tiqr
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("u2f") {
        <app-enroll-u2f
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("vasco") {
        <app-enroll-vasco
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("webauthn") {
        <app-enroll-webauthn
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)" />
      }
      @case ("passkey") {
        <app-enroll-passkey
          (additionalFormFieldsChange)="updateAdditionalFormFields($event)"
          (enrollmentArgsGetterChange)="updateEnrollmentArgsGetter($event)"
          (reopenDialogChange)="updateReopenDialog($event)" />
      }
    }
    <mat-form-field class="description-form">
      <mat-label>Description</mat-label>
      <textarea
        [formControl]="descriptionControl"
        [maxlength]="80"
        matInput
        placeholder="Enter description"
        rows="3"></textarea>
    </mat-form-field>

    @if (tokenService.selectedTokenType().key !== "passkey") {
      <div class="flex-column user-pin-container margin-bottom-16">
        <h4 class="enroll-h4">Set PIN</h4>
        <input
          class="hidden-input"
          type="text" />
        <input
          class="hidden-input"
          type="password" />
        <div class="user-pin-input">
          <input
            [formControl]="setPinControl"
            [type]="'password'"
            class="input"
            placeholder="PIN" />

          <input
            [formControl]="repeatPinControl"
            [type]="'password'"
            class="input"
            placeholder="Repeat PIN" />
        </div>
        @if (
          formGroupSignal().hasError("pinMismatch") &&
          (formGroupSignal().get("setPin")?.touched || formGroupSignal().get("repeatPin")?.touched)
        ) {
          <mat-error class="pin-error">PINs do not match.</mat-error>
        }
      </div>
    }

    <div class="flex-row gap-16">
      @if (authService.actionAllowed("container_list")) {
        <div class="flex-column width-100">
          <h4 class="enroll-h4">Add Token to a Container</h4>
          <mat-form-field class="width-47 input-height">
            <mat-label>Enter Container</mat-label>
            <app-clearable-input
              (onClick)="selectedContainerControl.setValue(null)"
              [showClearButton]="containerService.selectedContainer() !== ''">
              <input
                [formControlName]="'selectedContainer'"
                [formControl]="selectedContainerControl"
                [matAutocomplete]="containerAuto"
                matInput />
            </app-clearable-input>
            <mat-autocomplete #containerAuto="matAutocomplete">
              @for (option of containerService.filteredContainerOptions(); track option) {
                <mat-option [value]="option">{{ option }}</mat-option>
              }
            </mat-autocomplete>
          </mat-form-field>
        </div>
      }
    </div>
  </form>
</div>
