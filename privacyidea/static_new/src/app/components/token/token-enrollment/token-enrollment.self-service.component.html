<div #scrollContainer
     aria-label="Token Enrollment"
     class="token-enrollment-container">
  <h3 class="margin-left-1"> Enroll a New Token </h3>
  <form (ngSubmit)="enrollToken()"
        [formGroup]="formGroupSignal()">
    <div #stickySentinel></div>
    <div #stickyHeader class="sticky-header">
      <div class="sticky-controls ali-center">
        <div class="select-token-type-container">
          <mat-form-field class="width-100"
                          subscriptSizing="dynamic">
            <mat-select [(ngModel)]="tokenService.selectedTokenType"
                        [ngModelOptions]="{ standalone: true }"
                        [panelClass]="'multi-column-panel'">
              @for (type of tokenService.tokenTypeOptions(); track type) {
                <mat-option class="token-type-option type-option"
                            [value]="type"
                            [matTooltip]="type.info.split(':')[1]">{{ type.info.split(":")[0] }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
        <div class="enroll-button-container">
          <button [disabled]="formGroupSignal().invalid || !tokenService.selectedTokenType()"
                  [ngClass]="{'card-button-disabled': formGroupSignal().invalid || !tokenService.selectedTokenType(),
                              'card-button': true, 'width-100': true}"
                  mat-flat-button
                  type="submit">
            <mat-icon>add</mat-icon>
            Enroll
          </button>
          <button (click)="reopenEnrollmentDialog()"
                  [hidden]="!canReopenEnrollmentDialog()"
                  [matTooltip]="'Reopen enrollment dialog'"
                  mat-icon-button
                  type="button">
            <mat-icon>open_in_new</mat-icon>
          </button>
        </div>
      </div>
    </div>
    @switch (tokenService.selectedTokenType().key) {
      @case ("hotp") {
        <app-enroll-hotp (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                         (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("totp") {
        <app-enroll-totp (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                         (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("spass") {
        <app-enroll-spass (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                          (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("motp") {
        <app-enroll-motp (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                         (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("sshkey") {
        <app-enroll-sshkey (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                           (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("yubikey") {
        <app-enroll-yubikey (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                            (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("remote") {
        <app-enroll-remote (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                           (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("yubico") {
        <app-enroll-yubico (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                           (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("radius") {
        <app-enroll-radius (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                           (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("sms") {
        <app-enroll-sms (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                        (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("4eyes") {
        <app-enroll-foureyes (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                             (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("applspec") {
        <app-enroll-applspec (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                             (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("daypassword") {
        <app-enroll-daypassword (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                                (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("certificate") {
        <app-enroll-certificate (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                                (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("email") {
        <app-enroll-email (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                          (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("indexedsecret") {
        <app-enroll-indexedsecret (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                                  (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("paper") {
        <app-enroll-paper (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                          (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("push") {
        <app-enroll-push (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                         (clickEnrollChange)="updateClickEnroll($event)"
                         (reopenDialogChange)="updateReopenDialog($event)"/>
      }
      @case ("question") {
        <app-enroll-question (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                             (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("registration") {
        <app-enroll-registration (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                                 (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("tan") {
        <app-enroll-tan (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                        (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("tiqr") {
        <app-enroll-tiqr (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                         (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("u2f") {
        <app-enroll-u2f (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                        (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("vasco") {
        <app-enroll-vasco (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                          (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("webauthn") {
        <app-enroll-webauthn (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                             (clickEnrollChange)="updateClickEnroll($event)"/>
      }
      @case ("passkey") {
        <app-enroll-passkey (aditionalFormFieldsChange)="updateAdditionalFormFields($event)"
                            (clickEnrollChange)="updateClickEnroll($event)"
                            (reopenDialogChange)="updateReopenDialog($event)"/>
      }
    }
    <mat-form-field class="description-form">
      <mat-label>Description</mat-label>
      <textarea [formControl]="descriptionControl"
                [maxlength]="80"
                matInput
                placeholder="Enter description"
                rows="3"></textarea>
    </mat-form-field>
    <div class="flex-row gap-1">
      <div class="flex-column width-100">
        <h4 class="enroll-h4">Assign Token to a Container</h4>
        <mat-form-field class="width-47 input-height">
          <mat-label>Enter Container</mat-label>
          <input [formControlName]="'selectedContainer'"
                 [formControl]="selectedContainerControl"
                 [matAutocomplete]="containerAuto"
                 matInput/>
          <mat-autocomplete #containerAuto="matAutocomplete">
            @for (option of containerService.filteredContainerOptions();
              track option) {
              <mat-option [value]="option">{{ option }}</mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>
      </div>
      @if (tokenService.selectedTokenType().key !== "passkey") {
        <div class="flex-column user-pin-container">
          <h4 class="enroll-h4">Set PIN</h4>
          <input style="display: none"
                 type="text"/> <input style="display: none"
                                      type="password"/>
          <div class="user-pin-input">
            <input [formControl]="setPinControl"
                   [type]="'password'"
                   class="input"
                   placeholder="PIN"/>

            <input [formControl]="repeatPinControl"
                   [type]="'password'"
                   class="input"
                   placeholder="Repeat PIN"/>
          </div>
          @if (formGroupSignal().hasError("pinMismatch") &&
          (formGroupSignal().get("setPin")?.touched ||
            formGroupSignal().get("repeatPin")?.touched)) {
            <mat-error class="pin-error">PINs do not match.</mat-error>
          }
        </div>
      } @else {
        <div class="width-33"></div>
      }
    </div>
  </form>
</div>
