<!--
 (c) NetKnights GmbH 2025,  https://netknights.it

 This code is free software; you can redistribute it and/or
 modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
 as published by the Free Software Foundation; either
 version 3 of the License, or any later version.

 This code is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 GNU AFFERO GENERAL PUBLIC LICENSE for more details.

 You should have received a copy of the GNU Affero General Public
 License along with this program.  If not, see <http://www.gnu.org/licenses/>.

 SPDX-License-Identifier: AGPL-3.0-or-later
-->

<div class="template-card">
  <mat-expansion-panel
    #panel
    class="margin-4"
    [disabled]="isEditMode() && isTemplateEdited()"
    (opened)="handleExpansion()"
    (closed)="handleCollapse(panel)">
    <mat-expansion-panel-header>
      <div class="template-default-indicator-container">
        @if (panel.expanded) {
          <button
            mat-icon-button
            matTooltip="Set as default template"
            i18n-matTooltip
            (click)="$event.stopPropagation(); onDefaultToggle()">
            <mat-icon>{{ newTemplate().default ? "star" : "star_border" }}</mat-icon>
          </button>
        }
      </div>

      <div class="template-name-container">
        @if (panel.expanded) {
          <input
            type="text"
            class="template-name-input"
            placeholder="Template Name"
            [ngModel]="newTemplate().name"
            (ngModelChange)="onNameChange($event)"
            (click)="$event.stopPropagation(); panel.expanded = true"
            (keydown)="$event.stopPropagation()" />
        } @else {
          <p i18n>New Template</p>
        }
      </div>

      <div class="template-type-select-container">
        @if (panel.expanded) {
          <mat-select
            [ngModel]="newTemplate().container_type"
            (ngModelChange)="onTypeChange($event)"
            (click)="$event.stopPropagation()"
            (keydown)="$event.stopPropagation()"
            placeholder="Container Type"
            i18n-placeholder>
            @for (type of containerTemplateService.availableContainerTypes(); track type) {
              <mat-option [value]="type">
                {{ type }}
              </mat-option>
            }
          </mat-select>
        }
      </div>

      <div class="template-actions">
        @if (panel.expanded) {
          <button
            mat-icon-button
            [disabled]="!canSaveTemplate()"
            (click)="$event.stopPropagation(); saveTemplate(panel)">
            <mat-icon>save</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="$event.stopPropagation(); panel.close(); cancelEditMode()">
            <mat-icon>close</mat-icon>
          </button>
        }
      </div>
      @if (isTemplateEdited()) {
        <div class="expand-icon-spacer"></div>
      }
    </mat-expansion-panel-header>
    <div class="flex-column">
      <!-- <mat-card class="select-container-type-card">
        <mat-card-content>
          <mat-chip-listbox
            class="container-type-chips"
            [ngModel]="newTemplate().container_type"
            (ngModelChange)="onTypeChange($event)"
            aria-label="Container type selection">
            @for (type of containerTemplateService.availableContainerTypes(); track type) {
              <mat-chip-option [value]="type">{{ type }}</mat-chip-option>
            }
          </mat-chip-listbox>
        </mat-card-content>
      </mat-card> -->

      @if (newTemplate().container_type) {
        <app-container-template-add-token-chips
          [containerType]="newTemplate().container_type"
          (onAddToken)="onAddToken($event)" />
      }

      <div class="addedTokensList">
        @for (token of newTemplate().template_options.tokens; track $index) {
          <app-template-added-token-row
            [token]="token"
            [index]="$index"
            [isEditMode]="isEditMode()"
            (onEditToken)="onEditToken($event, $index)"
            (onRemoveToken)="onDeleteToken($event)">
          </app-template-added-token-row>
        }
      </div>
    </div>
  </mat-expansion-panel>
</div>
